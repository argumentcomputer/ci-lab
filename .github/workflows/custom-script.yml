name: Manual benchmarks

on:
  workflow_dispatch:
    inputs:
      script:
        description: 'Script to run'
        required: true
        type: string
      runner:
        description: 'GitHub Actions runner'
        required: true
        default: 'ubuntu-latest'
        type: choice
        options:
          - ubuntu-latest
          - buildjet-32vcpu-ubuntu-2204
          - gpu-l4-32vcpu

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  run:
    name: Run local fibonacci bench
    runs-on: ${{ github.event.inputs.runner }}
    steps:
      - uses: actions/checkout@v4
      # Install dependencies
      - uses: actions-rs/toolchain@v1
      - uses: Swatinem/rust-cache@v2
      - name: Set up GPU if applicable
        if: ${{ github.event.inputs.runner }} == "gpu-l4-32vcpu"
        run: |
          nvidia-smi
          nvcc --version
          echo "CUDA_ARCH=$(nvidia-smi --query-gpu=compute_cap --format=csv,noheader | sed 's/\.//g')" | tee -a $GITHUB_ENV
          echo "EC_GPU_CUDA_NVCC_ARGS=--fatbin --gpu-architecture=sm_${{ env.CUDA_ARCH }} --generate-code=arch=compute_${{ env.CUDA_ARCH }},code=sm_${{ env.CUDA_ARCH }}" | tee -a $GITHUB_ENV
          env | grep -E "LURK|EC_GPU|CUDA"
      # TODO: Remove
      - name: Test env vars
        if: ${{ github.event.inputs.runner }} != "gpu-l4-32vcpu"
        run: |
          echo "RUNNER_NUM_CPUS=$(nproc --all)" | tee -a $GITHUB_ENV
          echo "RUNNER_TYPE=cpu: ${{ env.RUNNER_NUM_CPUS }} vCPUS" | tee -a $GITHUB_ENV
      - name: Run input script
        run: |
          printf '#!/bin/bash\n\n${{ github.event.inputs.script }}' | tee script.sh
          chmod +x script.sh
          ./script.sh
